/*
 *--------------------------------------
 * Program Name: hp41c
 * Author: O2S
 * License: free
 * Description: keypad part
 *--------------------------------------
*/

#include "scanner.h"
#include "lcd.h"
#include "nut.h"

#include "../../api/extapp_api.h"

uint8_t bkey = 54;

static uint8_t kdown;

static const uint8_t keyTrans[57][8] = {
//   norm  +S    alpha +S    User  +S    PSKst PSKnn    
    {0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6},         // 00 sk_Left             USER
    {0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA, 0xCA},         // 01 sk_Up             x BST 
    {0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2, 0xC2},         // 02 sk_Down             SST
    {0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5, 0xC5},         // 03 sk_Right            PRGM
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 04 sk_Ok
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 05 sk_Back
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 06 sk_Home
    {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18},         // 07 sk_OnOff            ON
    {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18},         // 08 sk_OnOff            ON
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 09 
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 10 
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 11 
    {0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12, 0x12},         // 12 sk_Shift            gold
    {0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4, 0xC4},         // 13 sk_Alpha            ALPHA
    {0x32, 0x32, 0x3A, 0x32, 0x32, 0x32, 0x32, 0x32},         // 14 sk_XNT            x XEQ     APPEND APPEND
    {0x72, 0x72, 0x7A, 0x72, 0x72, 0x72, 0x72, 0x72},         // 15 sk_Var            x STO     ASTO ASTO
    {0x82, 0x82, 0x8A, 0x82, 0x82, 0x82, 0x82, 0x82},         // 16 sk_ToolBox        x RCL     ARCL ARCL
    {0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3},         // 17 sk_Backspace        <-
    {0xC8, 0xC8, 0x10, 0x10, 0xC8, 0xC8, 0x10, 0x10},         // 18 sk_Exp            x e^x     A   a   01 (Sig+)
    {0xC0, 0xC0, 0x30, 0x30, 0xC0, 0xC0, 0x30, 0x30},         // 19 sk_Ln               LN      B   b   02 (1/x)
    {0x80, 0x80, 0x70, 0x70, 0x80, 0x80, 0x70, 0x70},         // 20 sk_Log              LOG     C   c   03 (sqrt)
    {0x30, 0x30, 0x80, 0x80, 0x30, 0x30, 0x80, 0x80},         // 21 sk_Imaginary        1/x     D   d   04 (LOG)
    {0x10, 0x10, 0xC0, 0xC0, 0x10, 0x10, 0xC0, 0xC0},         // 22 sk_Comma            Sigma+  E   e   05 (ln)
    {0x38, 0x38, 0x11, 0x73, 0x38, 0x38, 0x11, 0x00},         // 23 sk_Power          x y^x     F   Â°
    {0x71, 0x71, 0x31, 0x71, 0x71, 0x71, 0x31, 0x11},         // 24 sk_Sine             SIN     G   !=  06 (x<>y)
    {0x81, 0x81, 0x71, 0x81, 0x81, 0x81, 0x71, 0x31},         // 25 sk_Cosine           COS     H   <   07 (Rv)
    {0xC1, 0xC1, 0x81, 0xC1, 0xC1, 0xC1, 0x81, 0x71},         // 26 sk_Tangent          TAN     I   >   08 (SIN)
    {0x73, 0x73, 0xC1, 0x71, 0x73, 0x73, 0xC1, 0x81},         // 27 sk_Pi               CHS     J   !=  09 (COS)
    {0x70, 0x70, 0x32, 0x81, 0x70, 0x70, 0x32, 0xC1},         // 28 sk_Sqrt             SQRT    K   <   10 (TAN)
    {0x78, 0x78, 0x72, 0xC1, 0x78, 0x78, 0x72, 0x00},         // 29 sk_Square         x x^2     L   >
    {0x34, 0x34, 0x82, 0x34, 0x34, 0x34, 0x82, 0x34},         // 30 sk_7                7       M   7
    {0x74, 0x74, 0x13, 0x74, 0x74, 0x74, 0x13, 0x74},         // 31 sk_8                8       N   8
    {0x84, 0x84, 0x73, 0x84, 0x84, 0x84, 0x73, 0x84},         // 32 sk_9                9       O   9
    {0x11, 0x11, 0x83, 0x11, 0x11, 0x11, 0x83, 0x11},         // 33 sk_LeftP            x<>y    P   Sigma
    {0x31, 0x31, 0x14, 0x31, 0x31, 0x31, 0x14, 0x31},         // 34 sk_RightP           Rv      Q   %
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 35 
    {0x35, 0x35, 0x34, 0x35, 0x35, 0x35, 0x34, 0x35},         // 36 sk_4                4       R   4
    {0x75, 0x75, 0x74, 0x75, 0x75, 0x75, 0x74, 0x75},         // 37 sk_5                5       S   5
    {0x85, 0x85, 0x84, 0x85, 0x85, 0x85, 0x84, 0x85},         // 38 sk_6                6       T   5
    {0x16, 0x16, 0x15, 0x16, 0x16, 0x16, 0x15, 0x16},         // 39 sk_Multiply         *       U   *
    {0x17, 0x17, 0x35, 0x17, 0x17, 0x17, 0x35, 0x17},         // 40 sk_Divide           /       V   /
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 41 
    {0x36, 0x36, 0x75, 0x36, 0x36, 0x36, 0x75, 0x36},         // 42 sk_1                1       W   1
    {0x76, 0x76, 0x85, 0x76, 0x76, 0x76, 0x85, 0x76},         // 43 sk_2                2       X   2
    {0x86, 0x86, 0x16, 0x86, 0x86, 0x86, 0x16, 0x86},         // 44 sk_3                3       Y   3
    {0x15, 0x15, 0x36, 0x15, 0x15, 0x15, 0x36, 0x15},         // 45 sk_Plus             +       Z   +
    {0x14, 0x14, 0x37, 0x14, 0x14, 0x14, 0x14, 0x14},         // 46 sk_Minus            -       ' ' -
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 47 
    {0x37, 0x37, 0x86, 0x37, 0x37, 0x37, 0x37, 0x37},         // 48 sk_0                0       ?   0
    {0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77},         // 49 sk_Dot              .       ,   .
    {0x83, 0x83, 0x17, 0x83, 0x83, 0x83, 0x83, 0x83},         // 50 sk_EE               EE      :   $
    {0x13, 0x13, 0x76, 0x13, 0x13, 0x13, 0x13, 0x13},         // 51 sk_Ans              ENTER   =   ^
    {0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87, 0x87},         // 52 sk_EXE              R/S
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},         // 53 
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}          // 54 sk_NONE
//   norm  +S    alpha +S    User  +S    PSKst PSKnn    
};

void kbdDown() {
    int j = 0;          // ffsL(key);
    if (bkey >= 53) return;
    if (kdown == 0) {           // no key
        if (stack[0] == 0x0DFA) {           // pkseq ST
            j = 6;
        } else if (stack[0] == 0x78A4) {   // ST _ for ccd osx
            j = 6;
        } else if (stack[0] == 0x0CED) {   // __ first digit    can use short cuts
            j = 7;
        } else if (stack[0] == 0x0E37) {   // x_ second digit
            j = 7;
        } else if (stack[0] == 0x0D4E) {   // GTO .1___ first digit
            j = 7;
        } else if (stack[0] == 0x0DC4) {   // IND __ first digit
            j = 7;
        } else if (stack[0] == 0x7145) {   // CAT" _ hex digit for ccd osx, PMTH
            j = 7;
        } else if (stack[0] == 0x7F6D) {   // CAT" 1 digit for ccd osx
            j = 7;
        } else if (stack[0] == 0x0D37) {   // ___ first digit (ccd osx ?)
            j = 7;
        } else {
            if (lE & 0x0080) {      // shift ?
                j += 1;
            } 
            if (lE & 0x0001) {      // alpha ?
                j += 2;
            } else {
                if (lE & 0x0400) {  // user ?
                    j += 4;
                }
            }
        }
        if (keyTrans[bkey][j] != 0) {
            kdown = keyTrans[bkey][j];
            if ((kdown & 0x08) && (kdown != 0x18)) {
                kdown ^= 0x08;
                lE ^= 0x0080;                   // toggle shift in annuciators
                ram[14][1] ^= 0x1;              // toggle shift in regs
            } 
            kbdPressKey(kdown);
        }
    }
}

void kbdUp() {
    if (kdown != 0) {
        kbdReleaseKey();
        kdown = 0;
    }
}

void keyLoop() {
    uint64_t key = extapp_scanKeyboard();
    bkey = (key != 0) ? 63 - __builtin_clzll(key) : 54;
}
